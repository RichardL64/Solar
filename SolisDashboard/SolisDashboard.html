<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <meta http-equiv="Content-Style-Type" content="text/css">
  <title></title>
</head>

<!--

	Proof concept dashboard to present Arduino gathered live SOLIS inverter data
	
	V2.1
	Circle based gauge construction vs. previous arcs
	Simplification & removal of external depdencies
	
	Data download from the server driven asynchronously
	Screen updates driven by browser animation API
	
	
	Parameters
		?inverter=solis.local -or- ?inverter=192.168.1.143
		Automatically replaced with the live IP addresss when served from the Arduino


	Uses and develops gauge drawing ideas from (Thank you):
		https://www.fullstacklabs.co/blog/creating-an-svg-gauge-component-from-scratch		
		https://github.com/naikus/svg-gauge


	R.Lincoln		July 2022

-->



<!--
	
	CSS
		
-->
<style>

body {
	font-family: sans-serif;
}

#gauges {
	width:90%;
	margin:auto; 
	display:grid;
	grid-template-columns: 1fr 1fr 1fr;
	padding: 10px;
	
/*	border:1px solid black; 	*/
}

#time {
	float:right;
}	

</style>


<body>

	<!--

		SVG shape definitions

		Move the stroke with stroke-dasharray="n, 251"
		Where n is proportional to 0-147

		Dial geometry:
				x,y				50, 50					pixels
				
				Radius							= 40	pixels
				Circumference	2 *Pi *40 		= 251 	pixels
				
				Dial circ.						  210 	degrees
								251 /360 *210	= 146 	pixels
								
					1% of dial	147 / 100		= 1.46
					
					mid point	147 /2 			= 73	pixels					
					rotation	270 -210 /2		= 165	degrees
					
	-->
	<svg width="0" height="0" xmlns="http://www.w3.org/2000/svg">
		<defs>
		
			<!--
				0 on the left, fills to the right
			-->
			<g id="gauge"
			stroke-width="6"
			fill="transparent"
			transform="rotate(165, 50, 50)">
				<circle class="track"
						cx="50" cy="50" r="40"
						stroke="whitesmoke"
						stroke-dasharray="146,251">
				</circle>
				<circle class="stroke"
						cx="50" cy="50" r="40">
				</circle>
				<circle class="tick"
						cx="50" cy="50" r="40"
						stroke="black"
						stroke-width="8"
						stroke-dasharray=".25, 251">
				</circle>
			</g>
			
			<!--
				0 in the middle, -ve left, +ve right
			-->
			<g id="gaugeMid"
			stroke-width="6"
			fill="transparent"
			transform="rotate(165, 50, 50)">
					<circle class="track"
							cx="50" cy="50" r="40"
							stroke="whitesmoke"
							stroke-dasharray="146,251">
					</circle>
					<circle class="stroke"
							cx="50" cy="50" r="40"
							stroke-dashoffset="-73">
					</circle>				
					<circle class="tick"
							cx="50" cy="50" r="40"
							stroke="black"
							stroke-width="8"
							stroke-dasharray=".25, 251"
							stroke-dashoffset="-73">
					</circle>
			</g>
			
		</defs>
	</svg>


	<!--
	
		Guage presentation
		
	-->
	<div id="gauges">

			<div id="Solar">
				Solar
				<svg viewbox="0 0 100 65" xmlns="http://www.w3.org/2000/svg">
					<use id="solarG" href="#gauge" 
						stroke="gold"
						stroke-dasharray="0, 251"
						transform="">
					</use>
					<text id="solarGT"
						x="50" y="50" 
						fill="darkgrey"
						text-anchor="middle" 
						alignment-baseline="middle"
						dominant-baseline="middle">
					</text>	
				</svg>
			</div>

			<div>
				Battery
				<svg viewbox="0 0 100 65" xmlns="http://www.w3.org/2000/svg">
					<use id="batteryG" href="#gaugeMid" 
						stroke="cornflowerblue"
						stroke-dasharray="0, 251"
						transform="">
					</use>
					<text id="batteryGT"
						x="50" y="50" 
						fill="darkgrey"
						text-anchor="middle" 
						alignment-baseline="middle"
						dominant-baseline="middle">
					</text>	
				</svg>
			</div>
			
			<div>
				Grid
				<svg viewbox="0 0 100 65" xmlns="http://www.w3.org/2000/svg">
					<use id="gridG" href="#gaugeMid"  
						stroke="cornflowerblue"
						stroke-dasharray="0, 251"
						transform="">
					</use>
					<text id="gridGT"
						x="50" y="50" 
						fill="darkgrey"
						text-anchor="middle" 
						alignment-baseline="middle"
						dominant-baseline="middle">
					</text>	
				</svg>
			</div>

			<div>
			</div>
			
			<div>
				<svg viewbox="0 0 100 65" xmlns="http://www.w3.org/2000/svg">
					<use id="batterySOCG" href="#gauge"  
						stroke="darkseagreen"
						stroke-dasharray="0, 251"
						transform="">
					</use>
					<text id="batterySOCGT" 
						x="50" y="50" 
						fill="darkgrey"
						text-anchor="middle" 
						alignment-baseline="middle"
						dominant-baseline="middle">
					</text>	
				</svg>
			</div>

			<div>
			</div>
			
			<div>
				Inverter temp. <label id="temp"></label>&#176C
			</div>
			<div>
			</div>
			<div>
				<label id="time"></label>
			</div>

	</div>



	</div>


	<!--
	
		Script
		
	-->
	<script>

		//	Parse the inverter URL parameter for callbacks
		//	When served from the arduino the live ip address replaces the hostname
		//
		function inverterURL() {
			const queryString = window.location.search;
			const urlParams = new URLSearchParams(queryString);
			let inverterURL = urlParams.get('inverter')
		
			if(inverterURL == null) inverterURL = "solis.local";
		
			console.log(inverterURL);
			return inverterURL;
		}
	
		//	Call the server for a data update
		//	Calls itself at the passed millis for updates
		//
		let newTime =0;
		let newJson = {};
		function callServer(freq) {
	
			fetch('http://' + URL + '/R?address=33057.2,33135,33149.2,33139,33130.2,33093')
			.then(res => res.json())
			.then(json => {
			
				newJson = json;
				if(json[33135] == 1) json[33149] *= -1			// Make battery signed - 0=chg, 1=dischg
				newTime = Date.now();
				console.log(newJson);

				})
			
			.catch(err => console.error(err))
			.finally(() => {
				setTimeout(callServer, freq, freq);				// Auto refresh
				});
		}


		//	Update the dashboard
		//	Called by the browser animation API so no fixed frequency
		//
		//	If the server update is old - display
		//	Else update from the most recent server response
		//	
		let lastCall = Date.now();
		let dispJson = {};
		function updateDashboard() {
			let thisCall = Date.now();						// work out our calling frequency
			let freq = thisCall-lastCall || 16;
			lastCall = thisCall;
								
			if(Date.now() - newTime > 5000) {				//	Old data? - warn and exit
				document.getElementById("time").innerHTML = "(Waiting for data)";
				setTimeout(updateDashboard, freq, freq);
				return;
			}

			//	Move dispJson towards newJson
			//	Naturally slows/inverse square as it gets close
			//
			for(const reg in newJson) {
				if(dispJson[reg] === undefined) dispJson[reg] = 0;
				let delta = (newJson[reg] - dispJson[reg]) || 0;
				let change = delta *freq /2000				// get there in n millis
				dispJson[reg] += change;
			}
			
			//	Update the gauges
			//
			let d = 2;
			setValue("solarG", 0, 4000, dispJson[33057], (dispJson[33057]/1000).toFixed(d) +"kW");			
			setValue("batteryG", -3500, 3500, dispJson[33149], (dispJson[33149]/1000).toFixed(d) +"kW");
			setValue("batterySOCG", 0, 100, dispJson[33139], dispJson[33139].toFixed(0) +"%");
			setValue("gridG", -10000, 3500, dispJson[33130], (dispJson[33130]/1000).toFixed(d) +"kW");
			
			document.getElementById("temp").innerHTML = (newJson[33093]/10).toFixed(1);

			let now = new Date();
			document.getElementById("time").innerHTML = "Updated at " + now.toLocaleTimeString();

			//	Callback via browser animation API
			//
			requestAnimationFrame(updateDashboard)
//			setTimeout(updateDashboard, freq, freq);
		}

		
		//	Startup
		//
		const URL = inverterURL()					// URL from ?inverter=
		callServer(2000);							// Data updates
		updateDashboard();							// Screen updates driven by browser animation
			


		//	Set the value and value text for the passed gauge ID
		//	Updates id and id+"T" elements
		//
		//	Where min is -ve the zero point is always at 12 o'clock
		//	Scales left/right of the central zero point can be different
		//
		function setValue(id, min, max, val, valDisp) {

			//	Value text
			document.getElementById(id + "T").textContent = valDisp;

			//	Min is +ve, draw from the left end
			if(min >= 0) {										// From left hand end
				let pn = toPercent(min, max, val);				// %
				let v = 1.46 * pn;								// * 1% of dial
				document.getElementById(id).setAttribute("stroke-dasharray", v + ", 251");
				return;	
			}

			//	Min is -ve, value is +ve draw from the middle right
			if(val >= 0) {
				let pn = toPercent(0, max, val);				// % 0...max
				let v = 1.46 * pn /2;							// * 1% of half the dial
				document.getElementById(id).setAttribute("stroke-dasharray", v + ", 251");
				document.getElementById(id).setAttribute("transform", "");
				return;
			}

			// Min is -ve, value is -ve, use -ve side scale and mirror the dial
			let pn = toPercent(0, min,  val);					// % min...0
			let v = 1.46 * pn /2;								// * 1% of half the dial
			document.getElementById(id).setAttribute("stroke-dasharray", v + ", 251");
			document.getElementById(id).setAttribute("transform", "translate(100,0) scale(-1,1)");

		}
		
		//	Give in value in the min-max range convert to 0-100
		//
		function toPercent(min, max, val) {
			let p = val *100 / (max-min);
			let pn = Math.min(Math.max(p, 0), 100);				// normalise 0-100
			return pn;
		}
		
	</script>

</body>

</html>
