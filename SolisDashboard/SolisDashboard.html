<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
  <meta http-equiv="Content-Style-Type" content="text/css">
  <title></title>
</head>

<!--

	Proof concept dashboard for Arduino gathering of SOLIS inverter data
	
	Uses
		SVC Gauges https://github.com/naikus/svg-gauge
		Modified for zero center stroke gauges with +- limits
		

	R.Lincoln		July 2022
	
-->

<script src="gauge.js"></script>

<style>

body {
	font-family: Verdana, sans-serif;
}

.gauge-container {
    width:300px;
	height:200px;
	overflow:hidden; 			
	padding:10px;
	float:left;
}
.gauge-container > .gauge .dial {
	stroke-width: 5;
}
.gauge-container > .gauge .value {
	stroke:cornflowerblue;
  	stroke-width: 5;
}

#gauges {
	width:960px;
	margin:auto;
/*	border:1px solid black; 	*/
}

#battSOCG {
	margin:auto;
	float:none;
}
#battSOCG > .gauge .value {
	stroke:darkseagreen;
}

</style>

<body>

<div id="gauges">
		<div id="solarG" class="gauge-container">
		Solar
		</div>
		<div id="batteryG" class="gauge-container">
		Battery
		</div>
		<div id="gridG" class="gauge-container">
		Grid
		</div>
		<div id="battSOCG" class="gauge-container">
		</div>
</div>

<script>
  var solarG = Gauge(
    document.getElementById("solarG"),
    {
      max: 4000,
      dialStartAngle: 170,
      dialEndAngle: 10,
      value: 0,
      label: function(value) {
        		return (value/1000).toFixed(2) + "kW";
      		  }
    }
  );
  var batteryG = Gauge(
    document.getElementById("batteryG"),
    {
      min: -3500,
      max: 3500,
      dialStartAngle: 170,
      dialEndAngle: 10,
      value: 0,
      label: function(value) {
        		return (value/1000).toFixed(2) + "kW";
      		  }
    }
  );
  var battSOCG = Gauge(
    document.getElementById("battSOCG"),
    {
      min: 0,
      max: 100,
      dialStartAngle: 170,
      dialEndAngle: 10,
      value: 0,
      label: function(value) {
        		return value.toFixed(0) + "%";
      		  }
    }
  );
  var gridG = Gauge(
    document.getElementById("gridG"),
    {
      min: -10000,
      max: 10000,
      dialStartAngle: 170,
      dialEndAngle: 10,
      value: 0,
      label: function(value) {
        		return (value/1000).toFixed(2) + "kW";
      		  }
    }
  );
  
  
	// Gauge values update from the server
	//
	function update() {
	
/*		Offline testing with random numbers
		fetch('http://solis.local/R?address=101')
        .then(res => res.json())
        	console.log(json);
			solarG.setValueAnimated(json["101"], 2);
*/

		fetch('http://solis.local/R?address=33057.2,33135,33149.2,33139,33130.2')
        .then(res => res.json())
        .then(json => {
        	console.log(json);
 
        	solarG.setValueAnimated(json[33057], 2);		// Solar W

        	let battW = json[33149];						// W
        	if(json[33135] == 1) battW = -battW				// 0=chg, 1=dischg
			batteryG.setValueAnimated(battW, 2);			// Battery W

			battSOCG.setValueAnimated(json[33139], 2);		// Battery SOC%
        	gridG.setValueAnimated(json[33130], 2);			// Grid

        	})
        .catch(err => console.error(err))
		.finally(() => {
			setTimeout(update,2000);						// Auto refresh
			});
			
	}
	
	//	Start updates
	//
	update();
	
</script>

</body>

</html>
